# Configuration Docker Compose pour orchestrer les services de l'application
# Ce fichier d√©finit les services suivants :
# - Base de donn√©es MySQL (pour les donn√©es principales)
# - Base de donn√©es MongoDB (pour Contact et horaires)
# - Adminer (interface web pour MySQL)
# - Mongo Express (interface web pour MongoDB)
# - Serveur Node.js (API Express)
# - Frontend React + Vite

services:
  # Service de base de donn√©es MySQL
  db:
    # Image Docker MySQL version 8.0 (plus stable que 9.5.0 pour Docker)
    image: mysql:8.0
    # Red√©marrage automatique du conteneur en cas d'arr√™t
    restart: always
    # Variables d'environnement pour configurer MySQL
    environment:
      MYSQL_ROOT_PASSWORD: root # Mot de passe pour l'utilisateur root
      MYSQL_DATABASE: vite_gourmand # Cr√©ation automatique de la base de donn√©es

    # Mapping des ports : port_h√¥te:port_conteneur
    # Le port 3306 (port par d√©faut de MySQL) est expos√© sur la machine h√¥te
    ports:
      - 3306:3306
    # Montage de volume pour les scripts d'initialisation
    # Les fichiers SQL dans ./mysql_data seront ex√©cut√©s au d√©marrage de la base
    # ‚ö†Ô∏è IMPORTANT : Ces scripts ne s'ex√©cutent QUE lors de la PREMI√àRE cr√©ation de la base
    # Si le volume MySQL est supprim√©, il faut r√©ex√©cuter manuellement les scripts
    volumes:
      - ./back/mysql_data:/docker-entrypoint-initdb.d
      - mysql_data:/var/lib/mysql # Volume nomm√© pour persister les donn√©es
    # Healthcheck pour v√©rifier que MySQL est pr√™t
    healthcheck:
      test:
        ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
  #Service de base de donn√©e MongoDB
  # Utillise√© pour stocker les donn√©es de contact et horaires
  mongodb:
    image: mongo:8.0
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: root
      MONGO_INITDB_DATABASE: vite_gourmand
    ports:
      - 27017:27017
    volumes:
      - mongodb_data:/data/db
  # Service Adminer : interface web pour g√©rer la base de donn√©es MySQL
  adminer:
    # Image Docker Adminer (outil de gestion de bases de donn√©es)
    image: adminer
    # Red√©marrage automatique du conteneur en cas d'arr√™t
    restart: always
    # Exposition du port 8080 pour acc√©der √† l'interface web
    ports:
      - 8080:8080
  # Service Mongo Express : intreface web pour g√©rer mongodb
  mongo-express:
    image: mongo-express:latest
    restart: always
    ports:
      - 8081:8081
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: root
      ME_CONFIG_MONGODB_ADMINPASSWORD: root
      ME_CONFIG_MONGODB_URL: mongodb://root:root@mongodb:27017/
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: admin
    depends_on:
      - mongodb
  # Conteneur d'initialisation de la base de donn√©es
  # S'ex√©cute une seule fois pour v√©rifier et initialiser la base si n√©cessaire
  db-init:
    image: mysql:8.0
    restart: "no" # Ne pas red√©marrer automatiquement
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./back/mysql_data:/scripts
    command: >
      sh -c "
        echo 'üîç V√©rification de l''√©tat de la base de donn√©es...' &&
        TABLE_COUNT=$$(mysql -h db -uroot -proot vite_gourmand -e 'SHOW TABLES LIKE \"menu\";' 2>/dev/null | tail -n +2 | wc -l | tr -d ' ') &&
        if [ \"$$TABLE_COUNT\" = \"0\" ]; then
          echo 'üìù Les tables n''existent pas. Initialisation de la base de donn√©es...' &&
          mysql -h db -uroot -proot vite_gourmand < /scripts/migration-v001.sql 2>/dev/null &&
          mysql -h db -uroot -proot vite_gourmand < /scripts/migration-password-reset.sql 2>/dev/null &&
          mysql -h db -uroot -proot vite_gourmand < /scripts/migration-avis-description.sql 2>/dev/null &&
          mysql -h db -uroot -proot vite_gourmand < /scripts/migration-avis-image.sql 2>/dev/null &&
          mysql -h db -uroot -proot vite_gourmand < /scripts/data-test-menus.sql 2>/dev/null &&
          mysql -h db -uroot -proot vite_gourmand < /scripts/data-test-avis.sql 2>/dev/null &&
          echo '‚úÖ Base de donn√©es initialis√©e avec succ√®s !'
        else
          echo '‚úÖ Les tables existent d√©j√†. Aucune initialisation n√©cessaire.'
        fi
      "

  # Service serveur Node.js (application Express)
  server:
    # Configuration du build de l'image Docker
    build:
      context: ./back # Contexte de build : r√©pertoire backend
      dockerfile: node.dockerfile # Fichier Dockerfile √† utiliser (relatif au context)
    # Red√©marrage automatique du conteneur en cas d'arr√™t
    restart: always
    # D√©pendances : le serveur attend que les bases de donn√©es soient pr√™tes
    # et que l'initialisation de la base soit termin√©e
    depends_on:
      db-init:
        condition: service_completed_successfully
      db:
        condition: service_healthy
      mongodb:
        condition: service_started
    # Exposition du port 3000 pour acc√©der √† l'API
    ports:
      - 3000:3000
    # Montage de volumes pour le d√©veloppement
    # Permet de modifier les fichiers sans reconstruire l'image
    volumes:
      - ./back:/app
      - /app/node_modules
    # Variables d'environnement pass√©es au conteneur
    environment:
      - DB_HOST=db # Nom du service db (r√©solu automatiquement par Docker)
      - MONGODB_URI=mongodb://root:root@mongodb:27017/vite_gourmand?authSource=admin # URI de connexion MongoDB
      - JWT_SECRET=rou2KL6nZnKVBo1UVkOoKIpxVzNl85xrFIdzzPj+eRMKlLfvB6jkt6yI3LLJB9q/DK5AoSQKsytxfa3/Ir3oxw== # Cl√© secr√®te pour JWT
      # Variables d'environnement pour l'envoi d'email (√† configurer selon votre service SMTP)
      - SMTP_HOST=smtp.gmail.com
      - SMTP_PORT=587
      - SMTP_SECURE=false
      - SMTP_USER=slimdev20@gmail.com
      - SMTP_PASSWORD=whhudfyrccrereze
      - SMTP_FROM=slimdev20@gmail.com
      - FRONTEND_URL=http://localhost:5173
    # Commande √† ex√©cuter au d√©marrage du conteneur
    command: sh -c "cd /app && npm run dev"
  # Service Frontend React + Vite
  frontend:
    # Configuration du build de l'image Docker
    build:
      context: ./frontend # Contexte de build : r√©pertoire frontend
      dockerfile: Dockerfile # Fichier Dockerfile √† utiliser
    # Red√©marrage automatique du conteneur en cas d'arr√™t
    restart: always
    # Exposition du port 5173 pour acc√©der √† l'application frontend
    ports:
      - 5173:5173
    # Montage de volumes pour le d√©veloppement
    # Permet de modifier les fichiers sans reconstruire l'image
    volumes:
      - ./frontend:/app
      - /app/node_modules
    # Variables d'environnement pass√©es au conteneur
    environment:
      - VITE_API_URL=http://localhost:3000/api # URL de l'API backend
    # D√©pendances : le frontend attend que le serveur backend soit pr√™t
    depends_on:
      - server

# Volumes nomm√©s pour persister les donn√©es
# Ces volumes permettent de conserver les donn√©es m√™me apr√®s l'arr√™t des conteneurs
volumes:
  mongodb_data: # Volume pour les donn√©es MongoDB
  mysql_data: # Volume pour les donn√©es MySQL (persiste les donn√©es entre les red√©marrages)
